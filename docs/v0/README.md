# Awesome Task Exchange System (aTES) для UberPopug Inc
## Роли

- **Р1: Администратор**
  - назначает, но не выполняет задачи
  - смотрит общую статистику по заработанным деньгам
  - смотрит аналитику

- **Р2: Менеджер**
  - назначает, но не выполняет задачи

- **Р3: Бухгалтер**
  - смотрит общую статистику по заработанным деньгам

- **Р4: Исполнитель**
  - любой сотрудник кроме менеджера и администратора
  - выполняет задачи
  - смотрит информацию по своему счету
  - смотрит список своих задач
  
- **Р5: Сотрудник (псевдо-роль)**
  - все авторизованные пользователи
  - создает задачи (исполнитель назначается автоматически)


## Сценарии использования

Ниже представлены сгруппированные сценарии использования с указанием ролей:

- **Трекинг задач**
  - создание задачи (Р5)
  - назначение исполнителя (Р1, Р2)
  - закрытие задачи (Р4)

- **Аккаунтинг**
  - просмотр информации по счету (Р4)
  - просмотр общей статистики (Р1, Р3)
  - автоматическая оплата счетов в конце дня (Система)

- **Аналитика**
  - просмотр аналитики (Р1)

## Базовая архитектура

![Базовая архитектура](baseline_architecture_diagram.svg)

### Возможные проблемы

1. Высокая завязанность на сервис авторизации остальных сервисов, как следствие точка отказа всей системы
2. Данные пользователя храняться в сервисе авторизации. Возможно стоит их вынести в отдельный сервис, а в качестве сервиса авторизации использовать готовое стороннее решение.
3. В качестве взаимодействия (Request-Reply) между сервисами используется HTTP протокол, что может быть не очень продуктивно. Можно заменить на gRPC (но тогда нужно продумать отдельное хранение proto-файлов и биндингов), либо на NATS (дополнительное ПО, которое нужно разворачивать с системой)
4. При параллельном (или даже очень частом) вызове "Назначения исполнителя" может происходить "гонка" (первый вызов назначения закончится позже второго), что будет приводить к нарушению порядка событий "ЗадачаНазначена", что приведет к разсогласованности данных. В расчетах выплат и списаний по задаче будет использоваться не тот пользователь, который фактически занимался задачей. Избежать можно добавлением очереди в один поток на действие "Назначения исполнителя".

## Сервис авторизации (auth)

Действия:
- Авторизовать пользователя (возвращает токен)
- Проверить доступ (передается токен, получаем роль)

Модель:
- users (логин, пароль, id роли, токен)
- roles (наименование роли, кодовое значение роли)

## Таск трекер (task-tracker)
Предназначен для работы над задачами, их просмотр, создание, назначение и выполнение.

Действия:
- Создать задачи
- Закрыть задачу
- Назначить испольнителей на открытые задачи
- Получить список задач

**Создать задачу**
1. Пользователь авторизуется и получает токен в сервисе авторизации
2. Пользователь передает описание задачи вместе с токеном
3. Проверка доступа (Р5) в сервисе авторизации
4. Вычисление рандомного исполнителя 
    - (нужно исключить менеджеров и админов, как?)
5. Сохранение в бд таска
6. Отправка события о созданной задачи *ЗадачаСоздана* (task_uuid)
7. Отправка события *ЗадачаНазначена* (task_uuid, user_uuid)

*шаг авторизации повторяется на каждом действии*

**Закрыть задачу**
1. Пользователь передает идентификатор задачи и токен
2. Проверка доступа (Р4) в сервисе авторизации
3. Сохранение в бд нового статуса таска
4. Отправка события *ЗадачаЗакрыта* (task_uuid)

**Назначить исполнителей**
1. Пользователь делает запрос передает токен
2. Проверка доступа (Р1, Р2) в сервисе авторизации
3. Запрашиваются все исполнители из сервиса пользователей
4. Назначение исполнители на все открытые задачи и сохраняет в бд
5. Отправка события *ЗадачаНазначена* (task_uuid, user_uuid) для каждой задачи

**Получить список задач**
1. Пользователь запрашивает список задач 
2. Проверка доступа (Р4) в сервисе авторизации
3. Возвращается список открытых задач пользователя

Модель данных:
- tasks (uuid, description, status, assignee_uuid)

## Аккаутинг
...

## Аналитика
...
